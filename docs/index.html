<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Deutsch A2‚ÄìB2 Trainer (Full)</title>
<style>
  :root { --gap:14px; --bg:#0f1220; --fg:#eef2ff; --panel:#151935; --muted:#283053;
          --ok:#0f3b23; --ok-b:#1dd17c; --bad:#511a21; --bad-b:#ff5c7a; --btn:#1c213a; --btn2:#3a5bff; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif}
  .wrap{max-width:960px;margin:0 auto;padding:20px}
  header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:clamp(18px,2.6vw,28px)}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  select,button,label{font-size:15px}
  select,button{border:0;padding:10px 14px;border-radius:12px;background:var(--btn);color:var(--fg)}
  button.primary{background:var(--btn2)}
  button.secondary{background:#283053}
  button:disabled{opacity:.55;cursor:not-allowed}
  .switch{display:flex;gap:10px;align-items:center}
  .switch input{accent-color:#3a5bff}
  input[type="file"]{display:none}

  .card{margin-top:16px;background:var(--panel);border:1px solid #212853;border-radius:18px;
        padding:clamp(14px,3vw,24px);box-shadow:0 10px 30px rgba(0,0,0,.25);min-height:420px}
  .level-topic{display:flex;gap:10px;flex-wrap:wrap;font-size:13px;opacity:.9;margin-bottom:8px}
  .badge{background:var(--muted);padding:4px 8px;border-radius:999px}

  /* ====== –†–ê–ó–ú–ï–†–´ –¢–ï–ö–°–¢–ê (–º–µ–Ω—è–π —Ç—É—Ç) ====== */
  .prompt{
    /* ‚¨áÔ∏è —É–≤–µ–ª–∏—á—å/—É–º–µ–Ω—å—à–∏ —ç—Ç–æ—Ç —Ä–∞–∑–º–µ—Ä –ø–æ –≤–∫—É—Å—É */
    font-size: clamp(26px, 6.2vw, 44px);
    margin:8px 0 6px; line-height:1.25; word-break:break-word;
    text-align:center;
  }
  .example{
    /* ‚¨áÔ∏è —É–≤–µ–ª–∏—á—å/—É–º–µ–Ω—å—à–∏ —ç—Ç–æ—Ç —Ä–∞–∑–º–µ—Ä –ø–æ –≤–∫—É—Å—É */
    font-size: clamp(16px, 3.8vw, 22px);
    color:#cbd5ff; margin: 10px 0 18px;
    text-align:center;
  }

  .options{display:grid;grid-template-columns:1fr;gap:10px;width:100%;margin-top:8px}
  @media(min-width:560px){.options{grid-template-columns:1fr 1fr 1fr}}
  .opt{padding:12px;border-radius:12px;background:#1c213a;border:1px solid #2a3367;
       min-height:52px;display:flex;align-items:center;justify-content:center;text-align:center}
  .opt.correct{background:var(--ok);border-color:var(--ok-b)}
  .opt.wrong{background:var(--bad);border-color:var(--bad-b)}

  .footer{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-top:16px}
  .progress{font-size:14px;opacity:.85}
  .hint{font-size:13px;opacity:.75}
  .error{margin-top:8px;color:#ff9aa5;font-size:14px;white-space:pre-wrap}
  .right-actions{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>üá©üá™ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤: —Å–ª–æ–≤–∞ + –ø—Ä–∏–º–µ—Ä—ã + —Ç–µ—Å—Ç</h1>
    <div class="controls">
      <div class="switch">
        <label><input type="radio" name="mode" value="de2ru" checked> DE‚ÜíRU</label>
        <label><input type="radio" name="mode" value="ru2de"> RU‚ÜíDE</label>
      </div>
      <select id="levelSelect" title="–£—Ä–æ–≤–µ–Ω—å">
        <option value="A2">A2</option><option value="B1">B1</option><option value="B2">B2</option>
        <option value="ALL">–í—Å–µ —É—Ä–æ–≤–Ω–∏</option>
      </select>
      <select id="topicSelect" title="–¢–µ–º–∞">
        <option value="all">–í—Å–µ —Ç–µ–º—ã</option>
      </select>
      <button class="secondary" id="btnShuffle">–ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
      <button class="secondary" id="btnWrong" disabled>–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—à–∏–±–æ—á–Ω—ã–µ</button>

      <!-- –†—É—á–Ω–æ–π –∏–º–ø–æ—Ä—Ç –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ -->
      <label class="secondary" for="fileInput" style="display:inline-block;padding:10px 14px;border-radius:12px;cursor:pointer;">–ó–∞–≥—Ä—É–∑–∏—Ç—å JSON</label>
      <input type="file" id="fileInput" accept=".json,application/json" />
      <!-- –ö–Ω–æ–ø–∫–∞ Next —Å —Ç–∞–π–º–µ—Ä–æ–º –≤–Ω–∏–∑—É -->
    </div>
  </header>

  <div class="card">
    <div class="level-topic" id="importBadges">
      <!-- —Å—é–¥–∞ –≤—ã–≤–µ–¥–µ–º –±–µ–π–¥–∂–∏ –ø–æ —Ñ–∞–π–ª–∞–º -->
      <span class="badge">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–≤–∞—Ä–µ–π‚Ä¶</span>
    </div>

    <div class="prompt" id="prompt">‚Äî</div>
    <div class="example" id="example"></div>

    <div class="options" id="options"></div>

    <div class="footer">
      <div class="progress" id="progress">1 / 1</div>
      <div class="right-actions">
        <div class="hint">–¢–∞–ø–Ω–∏ –ø–æ –≤–∞—Ä–∏–∞–Ω—Ç—É. –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ ‚Äî –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥.</div>
        <button class="primary" id="btnNext">Next ‚Üí</button>
      </div>
    </div>

    <div class="error" id="err"></div>
  </div>
</div>

<script>
/* ========= –ü–ê–†–ê–ú–ï–¢–†–´ ========= */
var AUTONEXT_SECONDS = 4; // ‚¨ÖÔ∏è –¢–∞–π–º–µ—Ä –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö. –ú–æ–∂–µ—à—å –º–µ–Ω—è—Ç—å.

/* ========= –§–ê–ô–õ–´ –¢–ï–ú (–ª–µ–∂–∞—Ç—å –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ docs/) ========= */
var TOPIC_FILES = [
  "arbeit.json",
  "bildung.json",
  "alltag.json",
  "it.json",
  "business.json",
  "restaurant.json",
  "urlaub.json",
  "familie.json"
];

/* ========= –°–û–°–¢–û–Ø–ù–ò–ï ========= */
var DATA = {A2:[], B1:[], B2:[]};  // –±–µ–∑ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö —Å–ª–æ–≤
var mode = "de2ru";       // de2ru | ru2de
var level = "A2";         // A2 | B1 | B2 | ALL
var topic = "all";
var source = [];          // –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
var order = [];           // –ø–æ—Ä—è–¥–æ–∫ –∏–Ω–¥–µ–∫—Å–æ–≤
var pointer = 0;          // –ø–æ–∑–∏—Ü–∏—è
var answeredWrong = {};   // { orderIndex: true }
var wrongCounter = 0;     // —Å—á—ë—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏

var countdownTimer = null, countdownTimeout = null, secondsLeft = AUTONEXT_SECONDS;

/* ========= DOM ========= */
var levelSelect   = document.getElementById('levelSelect');
var topicSelect   = document.getElementById('topicSelect');
var btnShuffle    = document.getElementById('btnShuffle');
var btnWrong      = document.getElementById('btnWrong');
var btnNext       = document.getElementById('btnNext');
var fileInput     = document.getElementById('fileInput');

var promptEl      = document.getElementById('prompt');
var exampleEl     = document.getElementById('example');
var optionsEl     = document.getElementById('options');
var progressEl    = document.getElementById('progress');
var errEl         = document.getElementById('err');
var importBadges  = document.getElementById('importBadges');

/* ========= –£–¢–ò–õ–´ ========= */
function shuffle(arr){ for(var i=arr.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1)); var t=arr[i]; arr[i]=arr[j]; arr[j]=t;} return arr; }
function flatAllLevels(){ return [].concat(DATA.A2||[], DATA.B1||[], DATA.B2||[]); }

/* ========= –ò–ù–ò–¶ ========= */
(function init(){
  // —Ä–µ–∂–∏–º
  var radios = document.getElementsByName('mode');
  for (var i=0;i<radios.length;i++){
    radios[i].addEventListener('change', function(e){ mode = e.target.value; renderCard(); });
  }
  // —Å–µ–ª–µ–∫—Ç—ã
  levelSelect.addEventListener('change', function(){ level = levelSelect.value; rebuildTopics(); applyFilters(); });
  topicSelect.addEventListener('change', function(){ topic = topicSelect.value; applyFilters(); });

  // –∫–Ω–æ–ø–∫–∏
  btnShuffle.addEventListener('click', function(){ cancelAutoNext(); resetOrder(); renderCard(); });
  btnWrong  .addEventListener('click', function(){ cancelAutoNext(); repeatWrong(); });
  btnNext   .addEventListener('click', function(){ cancelAutoNext(); nextCard(); });

  // –∑–∞–≥—Ä—É–∑–∫–∞ JSON –≤—Ä—É—á–Ω—É—é
  fileInput.addEventListener('change', onJsonChosen);

  // –∞–≤—Ç–æ–ø–æ–¥–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ —Ç–µ–º
  loadTopicFiles();
})();

/* ==== –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –ø–æ —Å–ø–∏—Å–∫—É ==== */
function loadTopicFiles(){
  importBadges.innerHTML = "";
  var loadedCount = 0;
  TOPIC_FILES.forEach(function(fname){
    fetch(fname+'?t='+(Date.now()), {cache:'no-store'})
      .then(function(r){
        if(!r.ok) throw new Error('HTTP '+r.status);
        return r.json();
      })
      .then(function(arr){
        var added = mergeImported(arr||[]);
        badge(fname, 'ok', added+' —à—Ç');
      })
      .catch(function(err){
        badge(fname, 'fail', '–Ω–µ—Ç —Ñ–∞–π–ª–∞');
      })
      .finally(function(){
        loadedCount++;
        if (loadedCount===TOPIC_FILES.length){
          rebuildTopics();
          applyFilters();
        }
      });
  });
}

function badge(name, status, text){
  var span = document.createElement('span');
  span.className = 'badge';
  span.textContent = name+': '+text;
  if(status==='ok') span.style.background = '#1e3a2a';
  if(status==='fail') span.style.background = '#402026';
  importBadges.appendChild(span);
}

function mergeImported(arr){
  var added=0;
  for (var i=0;i<arr.length;i++){
    var row = arr[i] || {};
    var L = (row.level||"").toUpperCase();
    if (L!=="A2" && L!=="B1" && L!=="B2") continue;
    if (!DATA[L]) DATA[L]=[];
    DATA[L].push({
      level:L,
      topic: row.topic || "Allgemein",
      de:    (row.de||"").toString(),
      ru:    (row.ru||"").toString(),
      ex_de: (row.ex_de||"").toString(),
      ex_ru: (row.ex_ru||"").toString()
    });
    added++;
  }
  return added;
}

/* ========= –§–ò–õ–¨–¢–†–´/–†–ï–ù–î–ï–† ========= */
function rebuildTopics(){
  var data = flatAllLevels();
  var topicsMap = {};
  for (var i=0;i<data.length;i++){ topicsMap[data[i].topic] = true; }
  var topics = Object.keys(topicsMap).sort();
  topicSelect.innerHTML = '<option value="all">–í—Å–µ —Ç–µ–º—ã</option>';
  for (var j=0;j<topics.length;j++){
    var o=document.createElement('option'); o.value=topics[j]; o.textContent=topics[j]; topicSelect.appendChild(o);
  }
  topic = 'all';
}

function applyFilters(){
  var base;
  if (level==="ALL") base = flatAllLevels();
  else base = (DATA[level]||[]);
  source = (topic==='all') ? base : base.filter(function(w){ return w.topic===topic; });
  if (!source || !source.length) { promptEl.textContent="–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ (–¥–æ–±–∞–≤—å JSON –≤ docs/)."; exampleEl.textContent=""; optionsEl.innerHTML=""; return; }
  answeredWrong = {};
  wrongCounter = 0;
  updateWrongButton();
  resetOrder();
  renderCard();
}

function resetOrder(){
  order = [];
  for (var i=0;i<source.length;i++) order.push(i);
  shuffle(order);
  pointer = 0;
  updateMeta();
}

function updateMeta(){
  progressEl.textContent = Math.min(pointer+1, order.length) + " / " + order.length;
}

function renderCard(){
  try{
    if (!order.length){ promptEl.textContent="–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫."; exampleEl.textContent=""; optionsEl.innerHTML=""; return; }

    var idx = order[pointer];
    var card = source[idx] || {};

    var q = (mode==='de2ru') ? (card.de||"") : (card.ru||"");
    var a = (mode==='de2ru') ? (card.ru||"") : (card.de||"");
    var ex= (mode==='de2ru') ? (card.ex_de||"") : (card.ex_ru||"");

    promptEl.textContent = q || "‚Äî";
    exampleEl.textContent = ex || "";

    // –≤–∞—Ä–∏–∞–Ω—Ç—ã
    var pool = [];
    for (var i=0;i<source.length;i++) if (i!==idx) pool.push(source[i]);
    if (pool.length < 2){ pool = (DATA[level]||[]).slice(0); }
    shuffle(pool);
    var distractors = [];
    for (var k=0;k<pool.length && distractors.length<2;k++){
      var txt = (mode==='de2ru') ? (pool[k].ru||"") : (pool[k].de||"");
      if (txt && txt!==a) distractors.push(txt);
    }
    while (distractors.length<2) distractors.push("‚Ä¶");

    var candidates = shuffle([a, distractors[0], distractors[1]]);

    optionsEl.innerHTML = "";
    for (var c=0;c<candidates.length;c++){
      (function(txt){
        var b=document.createElement('button');
        b.type="button"; b.className="opt"; b.textContent=txt;
        b.addEventListener('click', function(){ onAnswer(b, txt===a, a); });
        optionsEl.appendChild(b);
      })(candidates[c]);
    }
    resetNextLabel();
  } catch(e){
    console.error(e);
    errEl.textContent = "–û—à–∏–±–∫–∞: " + (e && e.message ? e.message : e);
  }
}

/* ========= –õ–û–ì–ò–ö–ê –û–¢–í–ï–¢–ê / –¢–ê–ô–ú–ï–† ========= */
function onAnswer(btn, correct, rightAnswer){
  var children = optionsEl.children;
  for (var i=0;i<children.length;i++) children[i].disabled = true;

  if (correct){ btn.classList.add('correct'); }
  else{
    btn.classList.add('wrong');
    for (var j=0;j<children.length;j++){
      if (children[j].textContent === rightAnswer) children[j].classList.add('correct');
    }
    if (!answeredWrong[pointer]){ // —Å—á–∏—Ç–∞–µ–º –∫–∞–∂–¥—É—é –∫–∞—Ä—Ç–æ—á–∫—É –º–∞–∫—Å–∏–º—É–º –æ–¥–∏–Ω —Ä–∞–∑
      answeredWrong[pointer] = true;
      wrongCounter++;
      updateWrongButton();
    }
  }
  startAutoNext();
}

function nextCard(){
  if (pointer < order.length-1){ pointer++; renderCard(); }
  else { progressEl.textContent = "–ì–æ—Ç–æ–≤–æ! " + order.length + " / " + order.length; }
}

function repeatWrong(){
  var keys = Object.keys(answeredWrong);
  if (!keys.length) return;
  var wrong = [];
  for (var i=0;i<keys.length;i++){
    var orderIdx = parseInt(keys[i],10);
    wrong.push( source[ order[orderIdx] ] );
  }
  source = wrong.length ? wrong : source;
  answeredWrong = {};
  wrongCounter = 0;
  updateWrongButton();
  resetOrder();
  renderCard();
}

function updateWrongButton(){
  btnWrong.disabled = (wrongCounter===0);
  btnWrong.textContent = wrongCounter ? ("–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—à–∏–±–æ—á–Ω—ã–µ ("+wrongCounter+")") : "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—à–∏–±–æ—á–Ω—ã–µ";
}

/* === –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∏ —Ç–∞–π–º–µ—Ä –Ω–∞ Next (–∫–Ω–æ–ø–∫–∞ –≤–Ω–∏–∑—É) === */
function startAutoNext(){
  cancelAutoNext();
  secondsLeft = AUTONEXT_SECONDS;
  setNextLabel(secondsLeft);
  countdownTimer = setInterval(function(){
    secondsLeft--; setNextLabel(secondsLeft);
    if (secondsLeft<=0){ clearInterval(countdownTimer); countdownTimer=null; }
  },1000);
  countdownTimeout = setTimeout(function(){ nextCard(); }, AUTONEXT_SECONDS*1000);
}
function cancelAutoNext(){
  if (countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; }
  if (countdownTimeout){ clearTimeout(countdownTimeout); countdownTimeout=null; }
  resetNextLabel();
}
function setNextLabel(s){ btnNext.textContent = "Next ("+s+")"; }
function resetNextLabel(){ btnNext.textContent = "Next ‚Üí"; }

/* === –ò–º–ø–æ—Ä—Ç JSON –≤—Ä—É—á–Ω—É—é (–∫–Ω–æ–ø–∫–æ–π) === */
function onJsonChosen(evt){
  var file = evt.target && evt.target.files && evt.target.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(){
    try{
      var arr = JSON.parse(reader.result || "[]");
      var added = 0;
      // –º–æ–∂–Ω–æ —Å–∫–æ—Ä–º–∏—Ç—å —Å—Ä–∞–∑—É –º–∞—Å—Å–∏–≤ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ç–µ–º
      added += mergeImported(arr);
      // –ø–æ—Å–ª–µ —Ä—É—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
      rebuildTopics(); applyFilters();
      errEl.textContent = "–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: " + added + " –∑–∞–ø–∏—Å–µ–π.";
      fileInput.value = "";
    } catch(e){
      errEl.textContent = "–û—à–∏–±–∫–∞ JSON: " + (e && e.message ? e.message : e);
    }
  };
  reader.readAsText(file, "utf-8");
}
</script>
</body>
</html>
